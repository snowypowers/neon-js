<html lang="zh-CN"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Advanced - Sending multiple transactions in a block · neon-js</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta property="og:title" content="Advanced - Sending multiple transactions in a block · neon-js"/><meta property="og:type" content="website"/><meta property="og:url" content="http://cityofzion.io/neon-js/index.html"/><meta property="og:description" content="In this tutorial, I shall go through how can we send multiple transactions within the same block."/><link rel="shortcut icon" href="/neon-js/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/dracula.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/neon-js/browser.js"></script><link rel="stylesheet" href="/neon-js/css/main.css"/></head><body class="sideNavVisible"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/neon-js/"><img class="logo" src="/neon-js/img/logo.svg"/><h2 class="headerTitle">neon-js</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li><a href="/neon-js/docs/zh-CN/installation.html" target="_self">文档</a></li><li><a href="/neon-js/docs/zh-CN/api-index.html" target="_self">API</a></li><li><a href="/neon-js/zh-CN/help.html" target="_self">Help</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/neon-js/img/language.svg"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/neon-js/en">English</a></li><li><a href="/neon-js/zh-CN">中文</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(){
          if(languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Guides</span></h2></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>开始</h3><ul><li class="navListItem"><a class="navItem" href="/neon-js/docs/zh-CN/overview.html">概述</a></li><li class="navListItem"><a class="navItem" href="/neon-js/docs/zh-CN/installation.html">安装</a></li></ul></div><div class="navGroup navGroupActive"><h3>教程</h3><ul><li class="navListItem"><a class="navItem" href="/neon-js/docs/zh-CN/basic_sendasset.html">Basic - Sending assets</a></li><li class="navListItem"><a class="navItem" href="/neon-js/docs/zh-CN/basic_claimgas.html">Basic - Claiming Gas</a></li><li class="navListItem"><a class="navItem" href="/neon-js/docs/zh-CN/basic_createscript.html">Basic - Create Smart Contract Script</a></li><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/neon-js/docs/zh-CN/adv_multitx.html">Advanced - Sending multiple transactions in a block</a></li></ul></div></div></section></div><script>
          var toggler = document.getElementById('navToggler');
          var nav = document.getElementById('docsNav');
          toggler.onclick = function() {
            nav.classList.toggle('docsSliderActive');
          };
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1>Advanced - Sending multiple transactions in a block</h1></header><article><div><span><p>In this tutorial, I shall go through how can we send multiple transactions within the same block.</p>
<p>If you have been using the current methods <code>sendAsset</code> and <code>doInvoke</code>, you would have realised that the second transaction coming out from the same address will fail if done quickly enough. This is due to the second transaction being unaware of the first transaction and thus it tries to spend the same inputs as the first transaction has used. Therefore, this is double spending and the node rejects our second transaction.</p>
<h2><a class="anchor" aria-hidden="true" name="a-look-at-the-balance-object"></a><a href="#a-look-at-the-balance-object" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>A look at the Balance object</h2>
<p>Within the Balance object, the assetBalance object looks like this::</p>
<pre><code class="hljs css js">{
  <span class="hljs-attr">balance</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">spent</span>: [],
  <span class="hljs-attr">unspent</span>: [
    { <span class="hljs-attr">txid</span>: <span class="hljs-string">'abc'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attr">txid</span>: <span class="hljs-string">'abc'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">5</span> }
  ],
  <span class="hljs-attr">unconfirmed</span>: []
}
</code></pre>
<p>Other than <code>balance</code>, each of the arrays is a list of <code>Coin</code> objects that basically represent a spendable transaction output. When we are constructing a transaction involving assets, <code>neon-js</code> selects coins from the <code>unspent</code> array, selecting more until there is enough to meet the demand as stated in the <code>intents</code>. The selected coins are transformed and added to the transaction as <code>inputs</code> while the <code>intents</code> are transformed and added to the transaction as <code>outputs</code>.</p>
<p>Once the transaction is sent off to a RPC node, we should not reuse the selected coins as inputs for a second transaction as that would be double spending. However, if we were to retrieve a new <code>Balance</code> object from the 3rd party provider such as neoscan, the <code>Balance</code> object will not take in account the recently sent transaction.</p>
<h2><a class="anchor" aria-hidden="true" name="applying-transaction"></a><a href="#applying-transaction" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Applying Transaction</h2>
<p>To deal with this problem, the program will have to retain the old <code>Balance</code> object and reuse it to make the second transaction. We register the transaction with the <code>Balance</code> object by calling the <code>applyTx</code> method:</p>
<pre><code class="hljs css js">  <span class="hljs-keyword">const</span> tx <span class="hljs-comment">// We assume that this is a tx that sends 3 NEO away.</span>
  <span class="hljs-built_in">console</span>.log(tx.hash) <span class="hljs-comment">// ghi</span>
  balance.applyTx(tx)
</code></pre>
<p>Now, our asset balance should look like:</p>
<pre><code class="hljs css js">{
  <span class="hljs-attr">balance</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">spent</span>: [{ <span class="hljs-attr">txid</span>: <span class="hljs-string">'abc'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">10</span> }],
  <span class="hljs-attr">unspent</span>: [{ <span class="hljs-attr">txid</span>: <span class="hljs-string">'abc'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">5</span> }],
  <span class="hljs-attr">unconfirmed</span>: [
    <span class="hljs-comment">// This is the change from spending the 5 neo</span>
    { <span class="hljs-attr">txid</span>: <span class="hljs-string">'ghi'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">value</span>: <span class="hljs-number">2</span>}
  ]
}
</code></pre>
<p>We can see that in order for us to send that 3 neo, we actually spent 5 neo and got back 2 neo. However, this effectively locks out 5 neo as we are unable to use that 2 neo until the transaction is confirmed. However, now we can create a new transaction without worry of double spending. Our second transaction can spend up to 10 neo.</p>
<h2><a class="anchor" aria-hidden="true" name="confirming-transaction"></a><a href="#confirming-transaction" aria-hidden="true" class="hash-link" ><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Confirming Transaction</h2>
<p>Once the transaction is confirmed, we can always reset by grabbing a fresh <code>Balance</code> object by asking our 3rd party provider. But for cases where we do not want to do that, the <code>confirm</code> function is a simple function to move all <code>unconfirmed</code> coins to <code>unspent</code>:</p>
<pre><code class="hljs css js">balance.confirm()
</code></pre>
<p>Now, our asset balance will look like:</p>
<pre><code class="hljs css ja">{
  <span class="hljs-attribute">balance</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attribute">spent</span>: [{ <span class="hljs-attribute">txid</span>: <span class="hljs-string">'abc'</span>, <span class="hljs-attribute">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">value</span>: <span class="hljs-number">10</span> }],
  <span class="hljs-attribute">unspent</span>: [
    { <span class="hljs-attribute">txid</span>: <span class="hljs-string">'abc'</span>,<span class="hljs-attribute">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">value</span>: <span class="hljs-number">10</span> },
    { <span class="hljs-attribute">txid</span>: <span class="hljs-string">'ghi'</span>, <span class="hljs-attribute">index</span>: <span class="hljs-number">0</span>, <span class="hljs-attribute">value</span>: <span class="hljs-number">2</span>}
  ],
  <span class="hljs-attribute">unconfirmed</span>: []
}
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="basic_createscript.html">← Basic - Create Smart Contract Script</a></div></div></div></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/neon-js/" class="nav-home"><img src="/neon-js/img/logo.svg" alt="neon-js" width="66" height="58"/></a><div><h5>Docs</h5><a href="/neon-js/docs/zh-CN/installation.html">Getting Started</a><a href="/neon-js/docs/zh-CN/tutorial.html">Guides</a><a href="/neon-js/docs/zh-CN/api.html">API Reference</a></div><div><h5>Community</h5><a href="/neon-js/zh-CN/users.html">User Showcase</a><a href="https://neo.stackexchange.com/" target="_blank">Stack Overflow</a><a href="https://discord.gg/wczVXTN">Discord Chat</a><a href="https://www.reddit.com/r/NEO/" target="_blank">NEO Reddit</a></div><div><h5>More</h5><a href="https://neo.org/" target="_blank">NEO</a><a href="https://github.com/cityofzion/neon-js" target="_blank">GitHub</a><a class="github-button" href="https://github.com/cityofzion/neon-js" data-icon="octicon-star" data-count-href="/cityofzion/neon-js/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><a href="http://cityofzion.io" target="_blank" class="fbOpenSource"><img src="/neon-js/img/coz_med.png" alt="City of Zion" width="150" height="150"/></a><section class="copyright">Copyright © 2018 City of Zion</section></footer></div></body></html>